CONFIG ?= pktchain
TARGET := sha256_axilite_slave
PICKLED_CONTEXT := $(FPGA_DIR)/ctx.pkl
SIM_MAKEFILE := Makefile.sim
TARGET_SRCS := ../testbench/$(TARGET).v ../sha256/src/rtl/sha256_core.v ../sha256/src/rtl/sha256_k_constants.v ../sha256/src/rtl/sha256_w_mem.v

.PHONY: all project
all: $(SIM_MAKEFILE) $(PICKLED_CONTEXT)
	make -f $(SIM_MAKEFILE)

project: $(SIM_MAKEFILE) $(PICKLED_CONTEXT)

clean:
	if [ -f $(SIM_MAKEFILE) ]; then make -f $(SIM_MAKEFILE) cleanall; fi
	rm -rf $(SIM_MAKEFILE) $(TARGET)_host_wrapper.v synth.ys io.pads

$(SIM_MAKEFILE): $(PICKLED_CONTEXT) $(IO_CONSTRAINTS) ../testbench/$(TARGET)_host.v $(TARGET_SRCS)
	python -m prga_tools.$(CONFIG).simproj \
		--fix_io $(IO_CONSTRAINTS) \
		-t ../testbench/$(TARGET)_host.v --testbench_top picorv32_wrapper \
		--testbench_plus_args max_cycle=10000000 quiet \
		-m $(TARGET_SRCS) --model_top sha256_axilite_slave \
		--makefile $@ \
		$(PICKLED_CONTEXT)

$(PICKLED_CONTEXT):
	make -C $(FPGA_DIR)

$(IO_CONSTRAINTS):

%: project
	make -f $(SIM_MAKEFILE) $@
